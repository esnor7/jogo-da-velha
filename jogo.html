<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jogo da Velha Online</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>

<h2 id="info"></h2>

<div class="tabuleiro">
  <div class="casa" onclick="jogar(0)"></div>
  <div class="casa" onclick="jogar(1)"></div>
  <div class="casa" onclick="jogar(2)"></div>
  <div class="casa" onclick="jogar(3)"></div>
  <div class="casa" onclick="jogar(4)"></div>
  <div class="casa" onclick="jogar(5)"></div>
  <div class="casa" onclick="jogar(6)"></div>
  <div class="casa" onclick="jogar(7)"></div>
  <div class="casa" onclick="jogar(8)"></div>
</div>

<!-- Controle de M칰sica -->
<div id="controleMusica">
  <label for="volumeMusica">Volume da m칰sica:</label>
  <select id="volumeMusica" onchange="ajustarVolume()">
    <option value="0">Mutar</option>
    <option value="0.05">5%</option>
    <option value="0.1">10%</option>
    <option value="0.15" selected>15%</option>
    <option value="0.2">20%</option>
  </select>
</div>

<button onclick="resetar()">Reiniciar</button>

<p id="rodapeJogo">
  Site desenvolvido por <span style="color:#00f;">Davi</span>
</p>

<!-- M칰sica de fundo -->
<audio id="musicaFundo" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAMPqH-lyB4X_whlGIW189rd5KVi2fM-IE",
  authDomain: "jogo-da-velha-online-36836.firebaseapp.com",
  databaseURL: "https://jogo-da-velha-online-36836-default-rtdb.firebaseio.com",
  projectId: "jogo-da-velha-online-36836"
});
const db = firebase.database();
</script>

<script>
const params = new URLSearchParams(window.location.search);
const j1 = params.get("j1");
const j2 = params.get("j2");
const jogoId = params.get("id");

let usuario = params.get("usuario");
if(!usuario) usuario = sessionStorage.getItem("usuario")?.trim();
if(!usuario || (usuario !== j1 && usuario !== j2)){
  alert("Voc칡 n칚o est치 em uma partida! Voltando  p치gina inicial.");
  window.location.href = "index.html";
}

// Sorteia aleatoriamente X ou O
function sortearSimbolos() {
  return Math.random() < 0.5 ? (usuario === j1 ? "X" : "O") : (usuario === j1 ? "O" : "X");
}

let meuSimbolo = sortearSimbolos();
const jogoRef = db.ref("jogos/" + jogoId);
const info = document.getElementById("info");
const casas = document.querySelectorAll(".casa");
const musicaFundo = document.getElementById("musicaFundo");

// volume inicial
musicaFundo.volume = 0.15;
musicaFundo.play().catch(()=> {
  document.body.addEventListener("click", ()=> musicaFundo.play(), {once:true});
});

// ajustar volume via select
function ajustarVolume(){
  musicaFundo.volume = parseFloat(document.getElementById("volumeMusica").value);
}

const vitorias = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

jogoRef.once("value").then(snap => {
  if(!snap.exists()){
    jogoRef.set({
      tabuleiro: ["","","","","","","","",""],
      turno: "X",
      ativo: true,
      j1,
      j2
    });
  }
});

function jogar(pos){
  jogoRef.once("value").then(snap => {
    const dados = snap.val();
    if(!dados || !dados.ativo) return;

    if(dados.turno !== meuSimbolo) return;
    if(dados.tabuleiro[pos] !== "") return;

    dados.tabuleiro[pos] = meuSimbolo;
    dados.turno = meuSimbolo === "X" ? "O" : "X";
    jogoRef.set(dados);
  });
}

jogoRef.on("value", snap => {
  const dados = snap.val();
  if(!dados) return;

  casas.forEach((casa,i)=>{
    casa.textContent = dados.tabuleiro[i];
  });

  if(dados.ativo){
    info.textContent = `Vez de ${dados.turno === "X" ? dados.j1 : dados.j2}`;
  }

  verificarFim(dados);
});

// Cria overlay central de vit칩ria/derrota
function mostrarMensagemCentral(mensagem, cor){
  let overlay = document.getElementById("overlayMensagem");
  if(!overlay){
    overlay = document.createElement("div");
    overlay.id = "overlayMensagem";
    document.body.appendChild(overlay);
  }
  overlay.textContent = mensagem;
  overlay.style.color = cor;
  overlay.style.display = "flex";
}

function verificarFim(dados){
  let vencedor = null;
  for(let [a,b,c] of vitorias){
    if(dados.tabuleiro[a] && dados.tabuleiro[a]===dados.tabuleiro[b] && dados.tabuleiro[a]===dados.tabuleiro[c]){
      vencedor = dados.tabuleiro[a] === "X" ? dados.j1 : dados.j2;
      jogoRef.update({ativo:false});
      if(vencedor === usuario){
        mostrarMensagemCentral("游끥 Vit칩ria!", "lime");
        explosaoConfete();
      } else {
        mostrarMensagemCentral("游 Derrota!", "red");
      }
      return;
    }
  }
  if(!dados.tabuleiro.includes("")){
    jogoRef.update({ativo:false});
    mostrarMensagemCentral("游뱋 Empate!", "orange");
    explosaoConfete();
  }
}

function explosaoConfete(){
  for(let i=0;i<100;i++){
    const confete = document.createElement("div");
    confete.classList.add("confete");
    confete.style.left = Math.random()*100 + "vw";
    confete.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
    confete.style.animationDuration = (2 + Math.random()*2) + "s";
    document.body.appendChild(confete);
    setTimeout(()=> confete.remove(), 4000);
  }
}

function resetar(){
  meuSimbolo = sortearSimbolos();
  let overlay = document.getElementById("overlayMensagem");
  if(overlay) overlay.style.display = "none";
  jogoRef.set({
    tabuleiro:["","","","","","","","",""],
    turno:"X",
    ativo:true,
    j1,
    j2
  });
}
</script>

<style>
body { 
  background:#111; 
  color:#fff; 
  text-align:center; 
  font-family:'Poppins',sans-serif; 
  padding:10px; 
  margin:0;
}

h2 { font-size:5vw; margin:10px 0; }

.tabuleiro { 
  display:grid; 
  grid-template-columns:repeat(3,1fr); 
  gap:3vw; 
  width:90vw; 
  max-width:400px; 
  margin:0 auto 3vw; 
}

.casa { 
  width:28vw; 
  max-width:120px; 
  height:28vw; 
  max-height:120px; 
  background:#333; 
  font-size:8vw; 
  display:flex; 
  justify-content:center; 
  align-items:center; 
  cursor:pointer; 
  border-radius:8px; 
  transition:0.2s;
}

.casa:hover { background:#555; }

button { 
  padding:3vw 6vw; 
  font-size:5vw; 
  border-radius:8px; 
  border:none; 
  cursor:pointer; 
  background:#888; 
  color:#fff; 
  margin-bottom:3vw;
}

#controleMusica {
  margin-bottom:3vw;
  font-size:4vw;
}

#rodapeJogo { 
  font-size:3vw; 
  color:#ccc; 
  margin-bottom:2vw;
}

/* Confete */
.confete {
  position: fixed;
  top: -10px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  pointer-events: none;
  animation-name: cair;
  animation-timing-function: ease-out;
}

@keyframes cair {
  0% { transform: translateY(0) rotate(0deg); opacity:1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity:0; }
}

/* Overlay central vit칩ria/derrota */
#overlayMensagem {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  font-size: 10vw;
  font-weight: bold;
  display: none;
  justify-content: center;
  align-items: center;
  text-align: center;
  pointer-events: none;
  z-index: 9999;
}
</style>

</body>
</html>
