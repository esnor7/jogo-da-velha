<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Jogo da Velha Online</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>

<h2 id="info"></h2>

<div class="tabuleiro">
  <div class="casa" onclick="jogar(0)"></div>
  <div class="casa" onclick="jogar(1)"></div>
  <div class="casa" onclick="jogar(2)"></div>
  <div class="casa" onclick="jogar(3)"></div>
  <div class="casa" onclick="jogar(4)"></div>
  <div class="casa" onclick="jogar(5)"></div>
  <div class="casa" onclick="jogar(6)"></div>
  <div class="casa" onclick="jogar(7)"></div>
  <div class="casa" onclick="jogar(8)"></div>
</div>

<button onclick="resetar()">Reiniciar</button>

<!-- Confete -->
<canvas id="confeteCanvas"></canvas>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAMPqH-lyB4X_whlGIW189rd5KVi2fM-IE",
  authDomain: "jogo-da-velha-online-36836.firebaseapp.com",
  databaseURL: "https://jogo-da-velha-online-36836-default-rtdb.firebaseio.com",
  projectId: "jogo-da-velha-online-36836"
});

const db = firebase.database();
</script>

<script>
const params = new URLSearchParams(window.location.search);
const j1 = params.get("j1");
const j2 = params.get("j2");
const jogoId = params.get("id");

const usuario = localStorage.getItem("usuario");
let meuSimbolo = usuario === j1 ? "X" : usuario === j2 ? "O" : alert("Voc√™ n√£o est√° nessa partida!");

const jogoRef = db.ref("jogos/" + jogoId);
const info = document.getElementById("info");
const casas = document.querySelectorAll(".casa");

const vitorias = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

// cria partida se n√£o existir
jogoRef.once("value").then(snap => {
  if (!snap.exists()) {
    jogoRef.set({
      tabuleiro: ["","","","","","","","",""],
      turno: "X",
      ativo: true,
      j1,
      j2
    });
  }
});

function jogar(pos) {
  jogoRef.once("value").then(snap => {
    const dados = snap.val();
    if (!dados || !dados.ativo) return;
    if (dados.turno !== meuSimbolo) return;
    if (dados.tabuleiro[pos] !== "") return;

    dados.tabuleiro[pos] = meuSimbolo;
    dados.turno = meuSimbolo === "X" ? "O" : "X";
    jogoRef.set(dados);
  });
}

// atualiza tabuleiro
jogoRef.on("value", snap => {
  const dados = snap.val();
  if (!dados) return;

  casas.forEach((casa, i) => {
    casa.textContent = dados.tabuleiro[i];
    casa.classList.remove("X","O");
    if (dados.tabuleiro[i]) casa.classList.add(dados.tabuleiro[i]);
  });

  info.textContent = dados.ativo
      ? `Vez de ${dados.turno === "X" ? dados.j1 : dados.j2}`
      : "";

  verificarFim(dados);
});

// verifica vencedor ou empate
function verificarFim(dados) {
  for (let [a,b,c] of vitorias) {
    if (
      dados.tabuleiro[a] &&
      dados.tabuleiro[a] === dados.tabuleiro[b] &&
      dados.tabuleiro[a] === dados.tabuleiro[c]
    ) {
      info.textContent = `üèÜ Vencedor: ${dados.tabuleiro[a] === "X" ? dados.j1 : dados.j2}`;
      jogoRef.update({ ativo: false });
      confete();
      return;
    }
  }

  if (!dados.tabuleiro.includes("")) {
    info.textContent = "ü§ù Empate!";
    jogoRef.update({ ativo: false });
  }
}

function resetar() {
  jogoRef.set({
    tabuleiro: ["","","","","","","","",""],
    turno: "X",
    ativo: true,
    j1,
    j2
  });
}

// Confete üéä
function confete() {
  const canvas = document.getElementById("confeteCanvas");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext("2d");
  const particulas = [];

  for(let i=0;i<150;i++){
    particulas.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height - canvas.height,
      r: Math.random()*6+4,
      d: Math.random()*20,
      color: `hsl(${Math.random()*360},100%,50%)`,
      tilt: Math.random()*10-10
    });
  }

  let angle = 0;

  function desenhar(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particulas.forEach(p=>{
      ctx.beginPath();
      ctx.fillStyle = p.color;
      ctx.moveTo(p.x + p.tilt, p.y);
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2, true);
      ctx.fill();

      p.tilt += 0.1;
      p.y += Math.cos(angle+p.d)+1+p.r/2;
      if(p.y>canvas.height){ p.y=0; p.x=Math.random()*canvas.width; }
    });
    angle += 0.1;
    requestAnimationFrame(desenhar);
  }

  desenhar();
}
</script>

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(-45deg,#111,#222,#333,#444);
  background-size: 400% 400%;
  animation: grad 15s ease infinite;
  color: #fff;
  text-align: center;
}

@keyframes grad {
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

h2 { margin-bottom: 20px; font-size: 24px; }

.tabuleiro {
  display: grid;
  grid-template-columns: repeat(3, 120px);
  gap: 15px;
  justify-content: center;
  margin: 20px auto;
}

.casa {
  width: 120px;
  height: 120px;
  background:#333;
  font-size: 60px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  border-radius: 16px;
  box-shadow: 0 0 10px #000;
  transition: all 0.3s;
}
.casa:hover { transform: scale(1.05); box-shadow: 0 0 20px #ff9800; }

.casa.X { color:#ff3b3b; text-shadow: 0 0 15px #ff3b3b; }
.casa.O { color:#39ff14; text-shadow: 0 0 15px #39ff14; }

button {
  padding: 12px 24px;
  font-size: 18px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: #ff9800;
  color: #fff;
  margin-top: 20px;
  font-weight: bold;
  transition: all 0.3s;
}
button:hover { background: #e68a00; transform: scale(1.05); }

#confeteCanvas {
  position: fixed;
  top:0; left:0;
  pointer-events:none;
  z-index:9999;
}
</style>

</body>
</html>
