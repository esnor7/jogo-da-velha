<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ESSENCIAL -->
  <title>Jogo da Velha Online</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>

<h2 id="info"></h2>

<div class="tabuleiro">
  <div class="casa" onclick="jogar(0)"></div>
  <div class="casa" onclick="jogar(1)"></div>
  <div class="casa" onclick="jogar(2)"></div>
  <div class="casa" onclick="jogar(3)"></div>
  <div class="casa" onclick="jogar(4)"></div>
  <div class="casa" onclick="jogar(5)"></div>
  <div class="casa" onclick="jogar(6)"></div>
  <div class="casa" onclick="jogar(7)"></div>
  <div class="casa" onclick="jogar(8)"></div>
</div>

<button onclick="resetar()">Reiniciar</button>

<p id="rodapeJogo">
  Site desenvolvido por <span style="color:#00f;">Davi</span>
</p>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAMPqH-lyB4X_whlGIW189rd5KVi2fM-IE",
  authDomain: "jogo-da-velha-online-36836.firebaseapp.com",
  databaseURL: "https://jogo-da-velha-online-36836-default-rtdb.firebaseio.com",
  projectId: "jogo-da-velha-online-36836"
});

const db = firebase.database();
</script>

<script>
const params = new URLSearchParams(window.location.search);
const j1 = params.get("j1");
const j2 = params.get("j2");
const jogoId = params.get("id");

let usuario = params.get("usuario");
if(!usuario) usuario = sessionStorage.getItem("usuario")?.trim();

if(!usuario || (usuario !== j1 && usuario !== j2)){
  alert("Voc√™ n√£o est√° em uma partida! Voltando √† p√°gina inicial.");
  window.location.href = "index.html";
}

let meuSimbolo = usuario === j1 ? "X" : "O";

const jogoRef = db.ref("jogos/" + jogoId);
const info = document.getElementById("info");
const casas = document.querySelectorAll(".casa");

const vitorias = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

jogoRef.once("value").then(snap => {
  if(!snap.exists()){
    jogoRef.set({
      tabuleiro: ["","","","","","","","",""],
      turno: "X",
      ativo: true,
      j1,
      j2
    });
  }
});

function jogar(pos){
  jogoRef.once("value").then(snap => {
    const dados = snap.val();
    if(!dados || !dados.ativo) return;

    if(dados.turno !== meuSimbolo) return;
    if(dados.tabuleiro[pos] !== "") return;

    dados.tabuleiro[pos] = meuSimbolo;
    dados.turno = meuSimbolo === "X" ? "O" : "X";
    jogoRef.set(dados);
  });
}

jogoRef.on("value", snap => {
  const dados = snap.val();
  if(!dados) return;

  casas.forEach((casa,i)=>{
    casa.textContent = dados.tabuleiro[i];
  });

  if(dados.ativo){
    info.textContent = `Vez de ${dados.turno === "X" ? dados.j1 : dados.j2}`;
  }

  verificarFim(dados);
});

function verificarFim(dados){
  for(let [a,b,c] of vitorias){
    if(dados.tabuleiro[a] && dados.tabuleiro[a]===dados.tabuleiro[b] && dados.tabuleiro[a]===dados.tabuleiro[c]){
      info.textContent = `üèÜ Vencedor: ${dados.tabuleiro[a]==="X"?dados.j1:dados.j2}`;
      jogoRef.update({ativo:false});
      return;
    }
  }
  if(!dados.tabuleiro.includes("")){
    info.textContent="ü§ù Empate!";
    jogoRef.update({ativo:false});
  }
}

function resetar(){
  jogoRef.set({
    tabuleiro:["","","","","","","","",""],
    turno:"X",
    ativo:true,
    j1,
    j2
  });
}
</script>

<style>
body { 
  background:#111; 
  color:#fff; 
  text-align:center; 
  font-family:'Poppins',sans-serif; 
  padding:10px; 
  margin:0;
}

h2 { font-size:5vw; margin:10px 0; }

.tabuleiro { 
  display:grid; 
  grid-template-columns:repeat(3,1fr); 
  gap:3vw; 
  width:90vw; 
  max-width:400px; 
  margin:0 auto 3vw; 
}

.casa { 
  width:28vw; 
  max-width:120px; 
  height:28vw; 
  max-height:120px; 
  background:#333; 
  font-size:8vw; 
  max-font-size:50px;
  display:flex; 
  justify-content:center; 
  align-items:center; 
  cursor:pointer; 
  border-radius:8px; 
  transition:0.2s;
}

.casa:hover { background:#555; }

button { 
  padding:3vw 6vw; 
  font-size:5vw; 
  border-radius:8px; 
  border:none; 
  cursor:pointer; 
  background:#888; 
  color:#fff; 
  margin-bottom:3vw;
}

#rodapeJogo { 
  font-size:3vw; 
  color:#ccc; 
  margin-bottom:2vw;
}
</style>

</body>
  </html>
